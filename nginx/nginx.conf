server {
    listen 80;

    # Единая точка входа для аутентификации
    # Любой запрос, пришедший в этот контейнер, будет требовать пароль
    auth_basic "Restricted Content";
    auth_basic_user_file /etc/nginx/.htpasswd;

    # Запросы к API отправляем на бэкенд
    location /api/ {
        # proxy_pass использует имя сервиса из docker-compose.yml и внутренний порт
        proxy_pass http://backend:8000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Все остальные запросы (на главную страницу, к файлам js, css и т.д.)
    # отправляем на фронтенд-сервер
    location / {
        # proxy_pass использует имя сервиса из docker-compose.yml.
        # Порт 3000 (Vite) или 80 (собранный проект), скорее всего, правильный,
        # так как в docker-compose.yml он не указан явно, а это стандарт.
        proxy_pass http://frontend:3000;  # Если не сработает, попробуем http://frontend
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_set_header Upgrade $http_upgrade; # Для корректной работы WebSocket и Vite HMR
        proxy_set_header Connection "upgrade";
    }
}
